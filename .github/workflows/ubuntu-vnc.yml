name: Ubuntu XFCE + RDP (Cloudflared)

on: [workflow_dispatch]

jobs:
  desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Update and install desktop + RDP
        run: |
          sudo apt update
          sudo apt install -y xfce4 xfce4-goodies xrdp wget curl
          sudo systemctl enable xrdp
          sudo adduser --disabled-password --gecos "" ubuntu
          echo "ubuntu:P@ssw0rd!" | sudo chpasswd
          sudo usermod -aG sudo ubuntu
          echo xfce4-session > ~/.xsession
          sudo cp ~/.xsession /home/ubuntu/.xsession
          sudo chown ubuntu:ubuntu /home/ubuntu/.xsession
          sudo systemctl restart xrdp

      - name: Install Chrome
        run: |
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt install -y ./google-chrome-stable_current_amd64.deb || sudo apt --fix-broken install -y

      - name: Install Cloudflared
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared

      - name: Start Cloudflared Tunnel
        run: |
          nohup ./cloudflared tunnel --url tcp://localhost:3389 > cloudflared.log 2>&1 &

      - name: Show Cloudflared Tunnel URL
        run: |
          sleep 10
          cat cloudflared.log | grep -o 'tcp://.*.trycloudflare.com:[0-9]*'
          
      - name: Prevent idle timeout
        run: |
          while true; do echo "Running..."; sleep 60; done
